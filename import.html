<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ - ã«ã‚ƒã‚“å¥åº·æ‰‹å¸³</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        .import-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .import-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .import-header h1 {
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .import-section {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
        }
        
        .import-section h2 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .file-input-wrapper {
            position: relative;
            margin-bottom: 15px;
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            background: var(--bg-section);
            border: 2px dashed var(--primary-light);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .file-label:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }
        
        .file-name {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 10px;
        }
        
        .preview-area {
            background: var(--bg-section);
            border-radius: var(--radius-md);
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.85rem;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .import-result {
            padding: 15px;
            border-radius: var(--radius-md);
            margin-top: 15px;
        }
        
        .import-result.success {
            background: rgba(107, 191, 138, 0.15);
            color: var(--success);
        }
        
        .import-result.error {
            background: rgba(235, 87, 87, 0.15);
            color: var(--danger);
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            margin-bottom: 20px;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat-item {
            background: var(--bg-section);
            padding: 12px;
            border-radius: var(--radius-md);
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="import-container">
        <a href="index.html" class="back-link">â† ã‚¢ãƒ—ãƒªã«æˆ»ã‚‹</a>
        
        <div class="import-header">
            <h1>ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h1>
            <p>éå»ã®ãƒ‡ãƒ¼ã‚¿ã‚’CSVã¾ãŸã¯JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã¾ã™</p>
        </div>

        <!-- CSV ã‚¤ãƒ³ãƒãƒ¼ãƒˆ -->
        <div class="import-section">
            <h2>ğŸ“„ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h2>
            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 15px;">
                æ—¥æ¬¡è¨˜éŒ²ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚
                <a href="data/lucky-daily.csv" download style="color: var(--primary);">ã‚µãƒ³ãƒ—ãƒ«CSV</a>
            </p>
            
            <div class="file-input-wrapper">
                <input type="file" id="csv-file" class="file-input" accept=".csv">
                <label for="csv-file" class="file-label">
                    <span style="font-size: 2rem;">ğŸ“„</span>
                    <span>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã¾ãŸã¯ãƒ‰ãƒ­ãƒƒãƒ—</span>
                </label>
                <div class="file-name" id="csv-file-name"></div>
            </div>
            
            <div class="form-row" style="margin-bottom: 15px;">
                <label style="width: auto; margin-right: 10px;">å¯¾è±¡ã®çŒ«:</label>
                <select id="csv-cat" style="padding: 10px; border-radius: 8px; border: 2px solid var(--bg-section);">
                    <option value="lucky">ãƒ©ãƒƒã‚­ãƒ¼</option>
                    <option value="mi">ãƒŸãƒ¼</option>
                </select>
            </div>
            
            <button class="submit-btn" onclick="importCSV()">
                ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ
            </button>
            
            <div id="csv-result"></div>
        </div>

        <!-- æŠ•è–¬CSV ã‚¤ãƒ³ãƒãƒ¼ãƒˆ -->
        <div class="import-section">
            <h2>ğŸ’Š æŠ•è–¬CSVã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h2>
            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 15px;">
                æŠ•è–¬è¨˜éŒ²ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚
                <a href="data/lucky-medicine.csv" download style="color: var(--primary);">ã‚µãƒ³ãƒ—ãƒ«CSV</a>
            </p>
            
            <div class="file-input-wrapper">
                <input type="file" id="medicine-file" class="file-input" accept=".csv">
                <label for="medicine-file" class="file-label">
                    <span style="font-size: 2rem;">ğŸ’Š</span>
                    <span>æŠ•è–¬CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</span>
                </label>
                <div class="file-name" id="medicine-file-name"></div>
            </div>
            
            <button class="submit-btn" style="background: linear-gradient(135deg, #7CBAAB 0%, #5a9a8b 100%);" onclick="importMedicineCSV()">
                ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ
            </button>
            
            <div id="medicine-result"></div>
        </div>

        <!-- JSON ã‚¤ãƒ³ãƒãƒ¼ãƒˆ -->
        <div class="import-section">
            <h2>ğŸ“‹ JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h2>
            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 15px;">
                ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸJSONãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã™ã€‚
            </p>
            
            <div class="file-input-wrapper">
                <input type="file" id="json-file" class="file-input" accept=".json">
                <label for="json-file" class="file-label">
                    <span style="font-size: 2rem;">ğŸ“‹</span>
                    <span>JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã¾ãŸã¯ãƒ‰ãƒ­ãƒƒãƒ—</span>
                </label>
                <div class="file-name" id="json-file-name"></div>
            </div>
            
            <button class="submit-btn secondary" onclick="importJSON()">
                ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ
            </button>
            
            <div id="json-result"></div>
        </div>

        <!-- ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆ -->
        <div class="import-section">
            <h2>ğŸ“Š ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿</h2>
            <div class="stats" id="data-stats">
                <div class="stat-item">
                    <div class="stat-value" id="daily-count">0</div>
                    <div class="stat-label">æ—¥æ¬¡è¨˜éŒ²</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="toilet-count">0</div>
                    <div class="stat-label">æ’æ³„è¨˜éŒ²</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="medicine-count">0</div>
                    <div class="stat-label">æŠ•è–¬è¨˜éŒ²</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="hospital-count">0</div>
                    <div class="stat-label">è¨ºå¯Ÿè¨˜éŒ²</div>
                </div>
            </div>
            
            <button class="submit-btn" style="background: var(--danger); margin-top: 20px;" onclick="clearAllData()">
                âš ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
            </button>
        </div>
    </div>

    <script>
        // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼
        const STORAGE_KEYS = {
            DAILY: 'catHealth_daily',
            TOILET: 'catHealth_toilet',
            MEDICINE: 'catHealth_medicine',
            HOSPITAL: 'catHealth_hospital'
        };

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç†
        document.getElementById('csv-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('csv-file-name').textContent = file.name;
            }
        });

        document.getElementById('json-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('json-file-name').textContent = file.name;
            }
        });

        document.getElementById('medicine-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('medicine-file-name').textContent = file.name;
            }
        });

        // CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        async function importCSV() {
            const fileInput = document.getElementById('csv-file');
            const catId = document.getElementById('csv-cat').value;
            const resultDiv = document.getElementById('csv-result');
            
            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '<div class="import-result error">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
                return;
            }
            
            try {
                const text = await fileInput.files[0].text();
                const lines = text.split('\n').filter(line => line.trim());
                const headers = lines[0].split(',');
                
                let imported = 0;
                const dailyData = JSON.parse(localStorage.getItem(STORAGE_KEYS.DAILY) || '{}');
                
                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    if (values.length < 5) continue;
                    
                    const date = formatDate(values[0]);
                    const key = `${catId}_${date}`;
                    
                    dailyData[key] = {
                        cat: catId,
                        date: date,
                        weight: values[2] || '',
                        energy: convertEnergy(values[3]),
                        appetite: convertAppetite(values[4]),
                        water: values[5] || '',
                        dryFood: values[6] || '',
                        wetFood: values[7] || '',
                        churu: values[8] || '',
                        treats: values[9] || '',
                        urineCount: values[10] || '',
                        fecesCount: values[11] || '',
                        fecesCondition: convertFecesCondition(values[12]),
                        drip: values[13] || '',
                        memo: values[14] || '',
                        updatedAt: new Date().toISOString()
                    };
                    imported++;
                }
                
                localStorage.setItem(STORAGE_KEYS.DAILY, JSON.stringify(dailyData));
                
                resultDiv.innerHTML = `<div class="import-result success">âœ… ${imported}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ</div>`;
                updateStats();
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="import-result error">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        }

        // CSVã®1è¡Œã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã€ã‚¯ã‚©ãƒ¼ãƒˆå¯¾å¿œï¼‰
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            
            return result;
        }

        // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›
        function formatDate(dateStr) {
            // 2025/11/15 -> 2025-11-15
            return dateStr.replace(/\//g, '-');
        }

        // å€¤å¤‰æ›é–¢æ•°
        function convertEnergy(value) {
            const map = { 'å…ƒæ°—': 'good', 'æ™®é€š': 'normal', 'ä½ä¸‹': 'low' };
            return map[value] || value;
        }
        
        function convertAppetite(value) {
            const map = { 'å¢—': 'good', 'æ™®é€š': 'normal', 'æ¸›': 'low', 'ãªã—': 'none' };
            return map[value] || value;
        }
        
        function convertFecesCondition(value) {
            const map = { 'è‰¯å¥½': 'good', 'ç¡¬ã„': 'hard', 'æŸ”ã‚‰ã‹ã„': 'soft', 'ãªã—': 'none' };
            return map[value] || value;
        }

        // æŠ•è–¬CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        async function importMedicineCSV() {
            const fileInput = document.getElementById('medicine-file');
            const resultDiv = document.getElementById('medicine-result');
            
            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '<div class="import-result error">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
                return;
            }
            
            try {
                const text = await fileInput.files[0].text();
                const lines = text.split('\n').filter(line => line.trim());
                
                let imported = 0;
                const medicineData = JSON.parse(localStorage.getItem(STORAGE_KEYS.MEDICINE) || '{}');
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦å„è¡Œã‚’å‡¦ç†
                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    if (values.length < 4) continue;
                    
                    const date = formatDate(values[0]);
                    const cat = values[1] === 'ãƒ©ãƒƒã‚­ãƒ¼' ? 'lucky' : 'mi';
                    const timing = convertTiming(values[2]);
                    
                    const key = `${cat}_${date}_${timing}`;
                    
                    // è–¬ã®ãƒªã‚¹ãƒˆ
                    const medicines = [];
                    if (values[3] === 'TRUE') medicines.push('rapros');
                    if (values[4] === 'TRUE') medicines.push('lactulose');
                    if (values[5] === 'TRUE') medicines.push('cranberry');
                    if (values[6] === 'TRUE') medicines.push('clavaseptin');
                    if (values[7] === 'TRUE') medicines.push('vibramycin');
                    if (values[8] === 'TRUE') medicines.push('uroact');
                    if (values[9] === 'TRUE') medicines.push('utclean');
                    if (values[10] === 'TRUE') medicines.push('veraflox');
                    if (values[11] === 'TRUE') medicines.push('appetite');
                    
                    medicineData[key] = {
                        cat: cat,
                        date: date,
                        timing: timing,
                        medicines: medicines,
                        memo: values[12] || '',
                        updatedAt: new Date().toISOString()
                    };
                    imported++;
                }
                
                localStorage.setItem(STORAGE_KEYS.MEDICINE, JSON.stringify(medicineData));
                
                resultDiv.innerHTML = `<div class="import-result success">âœ… ${imported}ä»¶ã®æŠ•è–¬è¨˜éŒ²ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ</div>`;
                updateStats();
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="import-result error">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        }

        function convertTiming(value) {
            const map = { 'æœ': 'morning', 'æ˜¼': 'noon', 'å¤œ': 'evening' };
            return map[value] || value;
        }

        // JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        async function importJSON() {
            const fileInput = document.getElementById('json-file');
            const resultDiv = document.getElementById('json-result');
            
            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '<div class="import-result error">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
                return;
            }
            
            try {
                const text = await fileInput.files[0].text();
                const data = JSON.parse(text);
                
                let counts = { daily: 0, toilet: 0, medicine: 0, hospital: 0 };
                
                if (data.daily) {
                    localStorage.setItem(STORAGE_KEYS.DAILY, JSON.stringify(data.daily));
                    counts.daily = Object.keys(data.daily).length;
                }
                if (data.toilet) {
                    localStorage.setItem(STORAGE_KEYS.TOILET, JSON.stringify(data.toilet));
                    counts.toilet = Object.values(data.toilet).flat().length;
                }
                if (data.medicine) {
                    localStorage.setItem(STORAGE_KEYS.MEDICINE, JSON.stringify(data.medicine));
                    counts.medicine = Object.keys(data.medicine).length;
                }
                if (data.hospital) {
                    localStorage.setItem(STORAGE_KEYS.HOSPITAL, JSON.stringify(data.hospital));
                    counts.hospital = Object.keys(data.hospital).length;
                }
                
                resultDiv.innerHTML = `
                    <div class="import-result success">
                        âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†<br>
                        æ—¥æ¬¡: ${counts.daily}ä»¶, æ’æ³„: ${counts.toilet}ä»¶,<br>
                        æŠ•è–¬: ${counts.medicine}ä»¶, è¨ºå¯Ÿ: ${counts.hospital}ä»¶
                    </div>
                `;
                updateStats();
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="import-result error">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        }

        // çµ±è¨ˆã‚’æ›´æ–°
        function updateStats() {
            const daily = JSON.parse(localStorage.getItem(STORAGE_KEYS.DAILY) || '{}');
            const toilet = JSON.parse(localStorage.getItem(STORAGE_KEYS.TOILET) || '{}');
            const medicine = JSON.parse(localStorage.getItem(STORAGE_KEYS.MEDICINE) || '{}');
            const hospital = JSON.parse(localStorage.getItem(STORAGE_KEYS.HOSPITAL) || '{}');
            
            document.getElementById('daily-count').textContent = Object.keys(daily).length;
            document.getElementById('toilet-count').textContent = Object.values(toilet).flat().length;
            document.getElementById('medicine-count').textContent = Object.keys(medicine).length;
            document.getElementById('hospital-count').textContent = Object.keys(hospital).length;
        }

        // å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
        function clearAllData() {
            if (confirm('æœ¬å½“ã«å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                localStorage.removeItem(STORAGE_KEYS.DAILY);
                localStorage.removeItem(STORAGE_KEYS.TOILET);
                localStorage.removeItem(STORAGE_KEYS.MEDICINE);
                localStorage.removeItem(STORAGE_KEYS.HOSPITAL);
                updateStats();
                alert('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            }
        }

        // åˆæœŸåŒ–
        updateStats();
    </script>
</body>
</html>

